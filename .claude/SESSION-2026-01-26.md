# Claude Code Session - 2026-01-26

## Session Summary

Working on Polyphony - a federated choral music sharing platform (SvelteKit + Cloudflare).

## Work Completed

### 1. Created CLAUDE.md ✅
- **File**: `/home/michelek/Documents/github/polyphony/CLAUDE.md`
- Comprehensive guide for future Claude Code instances
- Includes:
  - Project overview and architecture
  - Common development commands (dev, test, migrations)
  - Technology stack details
  - Critical patterns (multi-role system, chunked D1 storage, Svelte 5 Runes)
  - Database schemas
  - Workflow patterns
  - Active development from GitHub issues
  - Development tips

### 2. Created GitHub Issues

#### Issue #63 - Add invitation cleanup mechanism
- **URL**: https://github.com/mitselek/polyphony/issues/63
- **Status**: OPEN
- **Problem**: Expired invitations accumulate in database
- **Solution**: Admin UI to renew/remove invites (lazy cleanup, no cron)
- **Key decision**: `expires_at` timestamp is the marking mechanism, no need for redundant `status='expired'`
- **Approach**: Show expired invites with visual indicator, add "Renew" button
- **Emphasizes**: TDD and strict typing

#### Issue #65 - Roster table view (Tracking Issue)
- **URL**: https://github.com/mitselek/polyphony/issues/65
- **Status**: OPEN (tracking issue)
- **Purpose**: Spreadsheet-like participation view (members × events)
- **Key features**:
  - Past events show BOTH planned and actual attendance
  - Sticky headers (name column + top row)
  - Color coding for status
  - CSV export
  - Filters (date range, voice part)
  - Summary statistics

#### Sub-issues created (breaking down #65):

**#67 - Create roster view database layer**
- Database function: `getRosterView()`
- 12+ tests (TDD approach)
- Returns `RosterView` type with events, members, participation, summary, eventStats
- Filters by date range and voice part
- Depends on: #59

**#68 - Create roster view API endpoint**
- REST endpoint: `GET /api/events/roster`
- Query param validation with Zod
- JSON response
- 8 API tests
- Depends on: #67

**#69 - Add CSV export for roster**
- Content negotiation (Accept: text/csv)
- CSV utility with proper escaping
- Separate columns for planned/actual
- 5 CSV tests
- Depends on: #68

**#70 - Create roster table UI component**
- Svelte component with sticky headers
- Color-coded cells
- Responsive design (horizontal scroll)
- Filters UI + CSV export button
- Manual testing checklist
- Depends on: #68

**#71 - Add roster summary statistics display**
- Voice part breakdown
- Past event comparisons (planned vs actual)
- Percentage calculations
- Responsive grid layout
- Depends on: #70

### 3. Updated Existing Issues

#### Issue #59 - Participation database
- **Updated**: Status types aligned
- **PlannedStatus**: `'yes' | 'no' | 'maybe' | 'late'` (added 'late')
- **ActualStatus**: `'present' | 'absent' | 'late'`
- Members can plan to arrive late
- Conductor records actual attendance including late arrivals

#### Issue #53 - Epic: Events, Programs & Participation
- **Updated**: Added roster sub-issues to Phase 2
- Shows breakdown structure with #65 as tracking issue
- Updated types to include 'late' status
- Updated acceptance criteria

## Key Decisions Made

### 1. Invitation Cleanup Strategy
- **Decision**: NO background cleanup (cron jobs)
- **Approach**: Lazy cleanup via admin UI
- Show all pending invites (including expired) with visual indicators
- Add "Renew" button to extend expiration
- `expires_at` timestamp is single source of truth
- Redundant `status='expired'` field not needed

### 2. Roster Table View - Dual Display
- **Decision**: Show BOTH planned and actual for past events
- **Rationale**:
  - Historical analysis (compare intentions vs reality)
  - Pattern recognition (who says yes but doesn't show)
  - Transparency for all members
  - Better planning based on trends
- **Display**: Actual (bold, large) + planned (small, below: "was yes")

### 3. Status Type Alignment
- **PlannedStatus**: Added `'late'` option
- Members can indicate they'll attend but arrive late
- Aligns better with actual status tracking
- More realistic RSVP options

### 4. Breaking Down Large Issues
- **Decision**: Split #65 into 5 smaller issues
- **Benefits**:
  - Smaller, reviewable PRs
  - Parallel work possible
  - Incremental delivery
  - Focused testing per issue
  - Better estimates

## Current State

### Branch
- `feat/54-vault-settings` (uncommitted changes in CLAUDE.md)

### Untracked Files
```
?? apps/vault/migrations/0010_add_vault_settings.sql
?? apps/vault/src/lib/server/db/settings.ts
?? apps/vault/src/tests/lib/server/db/settings.spec.ts
```

### Recent Commits
```
e8e31fb fix(vault): update upload page authorization message
be2f5c5 fix(vault): redirect unauthorized users from upload page
e832038 feat(vault): hide Upload button from non-librarians on homepage
d16f717 feat(vault): hide upload/delete buttons for non-librarians
a630d72 feat(vault): add copy link button for pending invitations
```

## Next Steps

### Immediate (Issue #63)
1. Show all pending invites (remove `expires_at` filter from query)
2. Add visual indicator for expired invites
3. Create `renewInvite()` DB function (TDD)
4. Create `POST /api/invites/:id/renew` endpoint
5. Add "Renew" button to members page UI
6. Manual testing

### Phase 2 Work (Epic #53)
Work order for roster view (#65 sub-issues):
1. Complete #59 (participation database) - prerequisite
2. #67 (roster DB layer) - TDD, 12+ tests
3. #68 (roster API) - 8 tests
4. #69 (CSV export) - 5 tests
5. #70 (roster UI) - manual testing
6. #71 (statistics) - display components

### Other Open Work
- #54: Vault settings table (in progress - files exist)
- #55: Add conductor role
- #56-58: Events and programs
- #60: Participation UI (individual RSVP)

## Important Context for Next Session

### Technology Reminders
- **SvelteKit 2 + Svelte 5**: Use Runes (`$state`, `$derived`, `$effect`), NOT legacy `$:` syntax
- **Database**: Cloudflare D1 (SQLite), access via `platform.env.DB`
- **File storage**: D1 BLOBs (chunked), NO R2
- **Multi-role system**: Members can have multiple roles (junction table)
- **Testing**: Vitest for unit, Playwright for E2E
- **Validation**: Zod schemas for API requests

### Development Commands
```bash
# Vault dev server
cd apps/vault && pnpm dev

# Run all tests
pnpm test

# Type check
pnpm check

# Database migrations (from app directory)
wrangler d1 migrations apply DB --local
```

### Key Files to Remember
- Invites DB: `apps/vault/src/lib/server/db/invites.ts`
- Members page: `apps/vault/src/routes/members/+page.svelte`
- Permissions: `apps/vault/src/lib/server/auth/permissions.ts`
- Types: `apps/vault/src/lib/types.ts`

### Design Patterns to Follow
- TDD: Write tests first
- Strict TypeScript typing
- Zod validation for API endpoints
- Permission checks via `assertAdmin()`, `assertAuthenticated()` helpers
- Svelte 5: Reassign arrays/objects to trigger reactivity

## Questions/Discussions from Session

1. **Expired invitations**: Should we auto-cleanup?
   - **Answer**: No, admin UI control is better

2. **Past events in roster**: Show planned only or both?
   - **Answer**: Show BOTH for comparison/analysis

3. **Status types**: Should planned include 'late'?
   - **Answer**: Yes, more realistic

4. **Issue #65 scope**: Too large?
   - **Answer**: Yes, broke into 5 sub-issues

## Links
- Repository: https://github.com/mitselek/polyphony
- Epic #53: https://github.com/mitselek/polyphony/issues/53
- Issue #63: https://github.com/mitselek/polyphony/issues/63
- Issue #65: https://github.com/mitselek/polyphony/issues/65
- CLAUDE.md: `/home/michelek/Documents/github/polyphony/CLAUDE.md`
