# Migration History

| Migration | Description                                                                                                                                                                                                                  |
| --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **0001**  | **Complete schema** - Consolidated base schema with members, member_roles, scores, score_files, score_chunks, invites, sessions, takedowns, access_log, vault_settings, events, event_programs.                              |
| **0002**  | **Section leader role** - Added `section_leader` to member_roles CHECK constraint.                                                                                                                                           |
| **0003**  | **Voices and sections** - Added voices, sections, member_voices, member_sections, invite_voices, invite_sections tables. Removed voice_part columns from members and invites. Added triggers for single-primary enforcement. |
| **0004**  | **Remove default_voice_part** - Removed deprecated setting from vault_settings.                                                                                                                                              |
| **0010**  | **Participation** - Added participation table for RSVP (planned_status) and attendance tracking (actual_status).                                                                                                             |
| **0011**  | **Roster members** - Two-tier member system. Renamed `email` → `email_id`, added `email_contact`, made `name` required. Added `roster_member_id` to invites. Enables roster-only members without OAuth.                      |
| **0012**  | **Member nickname** - Added `nickname` column to members for compact display in roster and constrained views.                                                                                                                |
| **0013**  | **Works** - Added works table for abstract compositions (title, composer, lyricist).                                                                                                                                         |
| **0014**  | **Editions** - Added editions table (specific publications of works) and edition_sections junction table.                                                                                                                    |
| **0015**  | **Edition files** - Added edition_files and edition_chunks tables for D1 chunked PDF storage.                                                                                                                                |
| **0016**  | **Physical copies** - Added physical_copies table for inventory tracking.                                                                                                                                                    |
| **0017**  | **Copy assignments** - Added copy_assignments table for tracking who has which physical copy.                                                                                                                                |
| **0020**  | **Drop legacy scores** - Removed scores, score_files, score_chunks, access_log tables after migration to works/editions.                                                                                                     |
| **0021**  | **Event programs edition_id** - Renamed `score_id` → `edition_id` in event_programs table (deprecated).                                                                                                                      |
| **0022**  | **Seasons** - Added seasons table for annual/term-based repertoire organization.                                                                                                                                             |
| **0023**  | **Season repertoire** - Added season_works and season_work_editions tables for season-level repertoire.                                                                                                                      |
| **0024**  | **Event repertoire** - Added event_works and event_work_editions tables for event-level repertoire (replaces event_programs).                                                                                                |
| **0025**  | **Organizations** (Schema V2) - Added organizations table with types `umbrella` and `collective`. Seeded Kammerkoor Crede.                                                                                                   |
| **0026**  | **Drop event_programs** - Removed deprecated event_programs table after migration to event_works/event_work_editions.                                                                                                        |
| **0027**  | **Member organizations** (Schema V2) - Added member_organizations junction table linking members to orgs. Migrated existing members to Crede.                                                                                |
| **0028**  | **Member roles org_id** (Schema V2) - Added org_id to member_roles, changed PK to (member_id, org_id, role).                                                                                                                 |
| **0029**  | **Sections org_id** (Schema V2) - Added org_id to sections, added UNIQUE(org_id, name) constraint.                                                                                                                           |
| **0030**  | **Content org_id** (Schema V2) - Added org_id to events, works, seasons, invites. Changed seasons UNIQUE to (org_id, start_date).                                                                                            |
| **0031**  | **Affiliations** (Schema V2) - Added affiliations table for collective ↔ umbrella relationships with history tracking.                                                                                                       |
| **0032**  | **Festival event type** - Added `festival` to events.event_type CHECK constraint.                                                                                                                                            |
| **0033**  | **Organizations type index** - Added missing idx_organizations_type index.                                                                                                                                                   |
| **0034**  | **Organizations i18n** - Added language, locale, timezone columns to organizations table.                                                                                                                                    |
| **0035**  | **Member preferences** - Added member_preferences table for i18n overrides.                                                                                                                                                  |
| **0036**  | **Drop global name unique** - Dropped idx_members_name_lower (name uniqueness now per-org at app level).                                                                                                                     |
| **0037**  | **Fix primary section triggers** - Org-scoped primary section triggers (clear primaries only within same org).                                                                                                               |
| **0038**  | **Trust individual responsibility** - Added trust_individual_responsibility column to organizations.                                                                                                                         |
| **0039**  | **DATETIME to TEXT** - Rebuilt vault_settings, works, editions, physical_copies to normalize DATETIME columns to TEXT with `(datetime('now'))` default.                                                                      |
| **0040**  | **Settings org scope** - Added org_id to vault_settings, changed PK to composite (org_id, key) for multi-org isolation. Migrated existing rows to oldest organization.                                                       |
| **0041**  | **Scope takedowns** - D1-safe rebuild of takedowns table: renamed `score_id` → `edition_id` (FK → editions), added `org_id NOT NULL` (FK → organizations). Fixed orphaned FK to dropped `scores` table. Added indexes.      |
| **0042**  | **org_id NOT NULL** - D1-safe rebuild of events, works, invites to enforce `org_id TEXT NOT NULL`. Saves/restores 13 child/grandchild tables via `_tmp_*` pattern. All rows already had org_id set; this enforces at schema level. |
| **0043**  | **Voices org_id** (Schema V2) - D1-safe rebuild of voices table with `org_id NOT NULL` and `UNIQUE(org_id, name)`. Seeds per-org copies via CROSS JOIN. Restores member_voices/invite_voices with org-scoped voice IDs. Org-scoped primary voice triggers. |
