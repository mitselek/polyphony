name: Update Deployment Badge

on:
  push:
    branches: [main]
    paths:
      - 'apps/vault/**'
      - 'apps/registry/**'
      - 'packages/shared/**'
      - '.github/workflows/deployment-badge.yml'

jobs:
  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get commit info
        id: commit
        run: |
          SHA=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=short)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Deployment: $SHA on $DATE"

      - name: Update README with badge
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
          COMMIT_DATE: ${{ steps.commit.outputs.date }}
        run: |
          # Create badge URLs using shields.io
          VAULT_BADGE="https://img.shields.io/badge/vault%20deployment-${COMMIT_SHA}%20(${COMMIT_DATE})-blue?logo=cloudflare&logoColor=white&style=flat-square"
          REGISTRY_BADGE="https://img.shields.io/badge/registry%20deployment-${COMMIT_SHA}%20(${COMMIT_DATE})-green?logo=cloudflare&logoColor=white&style=flat-square"
          
          # Update or create deployment section in README
          python3 << 'EOF'
          import re
          
          vault_badge = "${{ env.VAULT_BADGE }}"
          registry_badge = "${{ env.REGISTRY_BADGE }}"
          commit_sha = "${{ steps.commit.outputs.sha }}"
          commit_date = "${{ steps.commit.outputs.date }}"
          
          with open('README.md', 'r') as f:
              content = f.read()
          
          # Find or create the Production section
          production_section = f"""## Production Status

**Vault:** [![Vault Deployment]({vault_badge})](https://polyphony-vault.pages.dev)  
**Registry:** [![Registry Deployment]({registry_badge})](https://polyphony-registry.pages.dev)

Latest: `{commit_sha}` on {commit_date}
"""
          
          # Check if section exists
          if '## Production Status' in content:
              # Replace existing section
              pattern = r'## Production Status\n\n.*?(?=\n##|\Z)'
              content = re.sub(pattern, production_section.rstrip(), content, flags=re.DOTALL)
          else:
              # Insert after "## How It Works" or at the beginning if not found
              if '## The Solution' in content:
                  # Insert after The Solution section
                  content = content.replace('## The Solution', f'{production_section}\n## The Solution')
              else:
                  # Insert after opening description
                  content = content.replace('---\n', f'---\n\n{production_section}\n')
          
          with open('README.md', 'w') as f:
              f.write(content)
          EOF

      - name: Commit and push badge update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "badge: Update deployment info to ${{ steps.commit.outputs.sha }} (${{ steps.commit.outputs.date }})"
            git push
          fi
